---
title: 微服务
date: 2020-08-11 19:41:36
permalink: /pages/4780f2/
categories: 
  - Java
  - 微服务
tags: 
  - 
---

## 微服务介绍

单体项目越来越大，启动时间越来越长

微服务框架主要是Spring Cloud和Dubbo

下一代微服务架构是Service Mesh，主流框架有Linkerd和Istio

### 优点

1. 提升开发交流，每个服务足够内聚，足够小，代码容易理解；
2. 服务独立测试、部署、升级、发布；
3. 按需定制的DFX，资源利用率，每个服务可以各自进行x扩展和z扩展，而且，每个服务可以根据自己的需要部署到合适的硬件服务器上；每个服务按
4. 需要选择HA的模式，选择接受服务的实例个数；
5. 容易扩大开发团队，可以针对每个服务（service）组件开发团队；
6. 提高容错性（fault isolation），一个服务的内存泄露并不会让整个系统瘫痪；
7. 新技术的应用，系统不会被长期限制在某个技术栈上；

### 缺点

1. 没有银弹，微服务提高了系统的复杂度；
2. 开发人员要处理分布式系统的复杂性；
3. 服务之间的分布式通信问题；
4. 服务的注册与发现问题；
5. 服务之间的分布式事务问题；
6. 数据隔离再来的报表处理问题；
7. 服务之间的分布式一致性问题；
8. 服务管理的复杂性，服务的编排；
9. 不同服务实例的管理

### 设计模式

1. 聚合器
2. 代理
3. 链式
4. 分支
5. 数据共享
6. 异步消息传递

## **没有银弹**

- 微服务架构整个应用分散成多个服务，定位故障点非常困难。

- 在微服务架构中，一个服务故障可能会产生雪崩效用，导致整个系统故障。

## **监控 - 发现故障的征兆**

- Redis缓存一般监控占用内存值、网络流量，数据库监控连接数、磁盘空间，业务服务监控并发数、响应延迟、错误率等。

- `RedisExporter`和`MySQLExporter`，这两个组件分别提供了Redis缓存和MySQL数据库的指标接口。

- 采用Prometheus作为指标采集器，Grafana配置监控界面和邮件告警。

## **定位问题 - 链路跟踪**

Dapper的一个开源实现Zipkin。然后手指一抖，写了个HTTP请求的拦截器，在每次HTTP请求时生成这些数据注入到HEADERS，同时异步发送调用日志到Zipkin的日志收集器中。

## **分析问题 - 日志分析**

- Elasticsearch：搜索引擎，同时也是日志的存储。
- Logstash：日志采集器，它接收日志输入，对日志进行一些预处理，然后输出到Elasticsearch。
- Kibana：UI组件，通过Elasticsearch的API查找数据并展示给用户。



> 每个服务里再部署个Agent扫描日志文件然后输出给Logstash。



## **网关 - 权限控制，服务治理**

- 最粗粒度的方案是整个微服务一个网关，微服务外部通过网关访问微服务，微服务内部则直接调用；

- 最细粒度则是所有调用，不管是微服务内部调用或者来自外部的调用，都必须通过网关。
- 折中的方案是按照业务领域将微服务分成几个区，区内直接调用，区间通过网关调用。

## **服务注册于发现 - 动态扩容**

- 部署新实例

- 将新实例注册到负载均衡或DNS上

- 解决这个问题的方案是服务自动注册与发现。

> Zookeeper 、Eureka、Consul、Etcd等



## 熔断

当一个服务因为各种原因停止响应时，调用方通常会等待一段时间，然后超时或者收到错误返回。如果调用链路比较长，可能会导致请求堆积，整条链路占用大量资源一直在等待下游响应。所以当多次访问一个服务失败时，应熔断，标记该服务已停止工作，直接返回错误。直至该服务恢复正常后再重新建立连接。



## 服务降级

当下游服务停止工作后，如果该服务并非核心业务，则上游服务应该降级，以保证核心业务不中断。比如网上超市下单界面有一个推荐商品凑单的功能，当推荐模块挂了后，下单功能不能一起挂掉，只需要暂时关闭推荐功能即可。

## 限流

一个服务挂掉后，上游服务或者用户一般会习惯性地重试访问。这导致一旦服务恢复正常，很可能因为瞬间网络流量过大又立刻挂掉，在棺材里重复着仰卧起坐。因此服务需要能够自我保护——限流。限流策略有很多，最简单的比如当单位时间内请求数过多时，丢弃多余的请求。另外，也可以考虑分区限流。仅拒绝来自产生大量请求的服务的请求。例如商品服务和订单服务都需要访问促销服务，商品服务由于代码问题发起了大量请求，促销服务则只限制来自商品服务的请求，来自订单服务的请求则正常响应。







